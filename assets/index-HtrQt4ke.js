import{r as D,a as j,o as oe,c as V,w as ne,b as de,n as ue,d as _,e,f as A,g as J,t as p,u as v,h as X,v as ve,F as K,i as Q,j as G,k as se,l as he,m as ee,p as b,q as ge}from"./vendor-DiGE_4UQ.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))y(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const f of r.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&y(f)}).observe(document,{childList:!0,subtree:!0});function c(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function y(s){if(s.ep)return;s.ep=!0;const r=c(s);fetch(s.href,r)}})();function fe(){const h=D(!1),n=D(!1),c=D(!1),y=D(null),s=j({x:0,y:0,width:0,height:0,confidence:0,headPose:{yaw:0,pitch:0,roll:0}}),r=D(null),f=D(null),x=D(null),k=j({targetFPS:30,smoothingFactor:.7,confidenceThreshold:.5,debugMode:!0}),m=j({fps:0,frameCount:0,lastUpdate:Date.now()});let P=null,C=null,I=0;const L=async()=>{try{if(console.log("🚀 ブラウザネイティブ顔検出初期化開始"),!("FaceDetector"in window)){console.log("⚠️ ブラウザネイティブFaceDetectorが利用できません"),await E();return}P=new FaceDetector({maxDetectedFaces:1,fastMode:!0}),console.log("✅ ブラウザネイティブ顔検出初期化完了"),h.value=!0}catch(l){console.error("❌ ネイティブ顔検出初期化エラー:",l),await E()}},E=async()=>{console.log("🔄 フォールバック顔検出システム初期化中...");try{await T(),console.log("✅ フォールバック顔検出初期化完了"),h.value=!0}catch(l){console.error("❌ フォールバック初期化失敗:",l),y.value="顔検出システムの初期化に失敗しました"}},T=async()=>{console.log("🎯 シンプル顔検出システム初期化"),h.value=!0},$=async(l={})=>{try{const a=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640,max:1280},height:{ideal:480,max:720},frameRate:{ideal:30},facingMode:"user",...l}});return r.value&&(r.value.srcObject=a,await r.value.play(),console.log("📹 カメラストリーム開始:",{width:r.value.videoWidth,height:r.value.videoHeight})),a}catch(a){throw console.error("❌ カメラアクセスエラー:",a),y.value=`カメラアクセス失敗: ${a.message}`,a}},Z=async(l,a)=>{try{r.value=l,f.value=a,a&&(x.value=a.getContext("2d")),h.value||await L(),await $(),q(),n.value=!0,console.log("✅ シンプル視線追跡開始")}catch(g){console.error("❌ 追跡開始エラー:",g),y.value=`追跡開始失敗: ${g.message}`}},q=()=>{const l=async a=>{if(n.value){if(a-I<1e3/k.targetFPS){C=requestAnimationFrame(l);return}I=a;try{await B(),S()}catch(g){console.error("フレーム処理エラー:",g)}C=requestAnimationFrame(l)}};C=requestAnimationFrame(l)},B=async()=>{if(!r.value||!f.value)return;const l=r.value,a=f.value,g=x.value;if(a.width=l.videoWidth,a.height=l.videoHeight,g.drawImage(l,0,0,a.width,a.height),P)try{const z=await P.detect(a);H(z)}catch{U(g,a)}else U(g,a)},H=l=>{if(l&&l.length>0){const a=l[0];c.value=!0;const g=a.boundingBox;s.x=g.x+g.width/2,s.y=g.y+g.height/2,s.width=g.width,s.height=g.height,s.confidence=a.confidence||.8,o(g),k.debugMode&&t(g)}else c.value=!1,i()},U=(l,a)=>{const z=l.getImageData(0,0,a.width,a.height).data;let F=0,N=0,R=0,W=0;for(let O=0;O<z.length;O+=4){const ae=z[O],ie=z[O+1],le=z[O+2];if(Y(ae,ie,le)){const te=O/4,re=te%a.width,ce=Math.floor(te/a.width);R+=re,W+=ce,F++}N++}F>N*.05?(c.value=!0,s.x=R/F,s.y=W/F,s.width=Math.sqrt(F)*2,s.height=Math.sqrt(F)*2.5,s.confidence=Math.min(F/(N*.1),1),o({x:s.x-s.width/2,y:s.y-s.height/2,width:s.width,height:s.height})):(c.value=!1,i())},Y=(l,a,g)=>l>95&&a>40&&g>20&&l>a&&l>g&&Math.abs(l-a)>15&&l-g>15,o=l=>{const a=f.value;if(!a)return;const g=l.x+l.width/2,z=l.y+l.height/2,F=a.width/2,N=a.height/2,R=(g-F)/F,W=(z-N)/N;s.headPose.yaw=R*30,s.headPose.pitch=W*20,s.headPose.roll=0,w()};let d={yaw:0,pitch:0,roll:0};const w=()=>{const l=k.smoothingFactor;s.headPose.yaw=u(d.yaw,s.headPose.yaw,l),s.headPose.pitch=u(d.pitch,s.headPose.pitch,l),s.headPose.roll=u(d.roll,s.headPose.roll,l),d={...s.headPose}},u=(l,a,g)=>l+(a-l)*g,t=l=>{const a=x.value;a&&(a.strokeStyle="#00ff00",a.lineWidth=2,a.strokeRect(l.x,l.y,l.width,l.height),a.fillStyle="#ff0000",a.beginPath(),a.arc(s.x,s.y,5,0,2*Math.PI),a.fill(),a.fillStyle="#00ff00",a.font="16px Arial",a.fillText(`信頼度: ${Math.round(s.confidence*100)}%`,10,30),a.fillText(`FPS: ${m.fps}`,10,50),a.fillText(`Yaw: ${Math.round(s.headPose.yaw)}°`,10,70),a.fillText(`Pitch: ${Math.round(s.headPose.pitch)}°`,10,90))},i=()=>{s.x=0,s.y=0,s.width=0,s.height=0,s.confidence=0,s.headPose={yaw:0,pitch:0,roll:0}},S=()=>{m.frameCount++;const l=Date.now();l-m.lastUpdate>=1e3&&(m.fps=Math.round(m.frameCount*1e3/(l-m.lastUpdate)),m.frameCount=0,m.lastUpdate=l)},M=()=>{n.value=!1,C&&(cancelAnimationFrame(C),C=null),r.value&&r.value.srcObject&&(r.value.srcObject.getTracks().forEach(a=>a.stop()),r.value.srcObject=null),i(),console.log("⏹️ シンプル視線追跡停止")};return oe(()=>{M()}),{isInitialized:h,isTracking:n,faceDetected:c,error:y,faceData:s,settings:k,stats:m,initializeFaceDetection:L,startTracking:Z,stopTracking:M,startCamera:$}}function me(h){const n=D(null),c=D(!1),y=D(null),s=D(0),r=j({gridSize:3,dwellTime:1500,confidenceThreshold:.7,stabilityThreshold:300,smoothing:!0,visualFeedback:!0}),f=V(()=>{const o=r.gridSize,d=r.gridSize,w=100/o,u=100/d,t=[];for(let i=0;i<d;i++)for(let S=0;S<o;S++){const M=i*o+S,l=x(i,S);t.push({id:M,name:l,row:i,col:S,x:S*w,y:i*u,width:w,height:u,centerX:S*w+w/2,centerY:i*u+u/2,active:!1,hovered:!1,dwellStart:null})}return t}),x=(o,d)=>{const w=["上","中","下"],u=["左","中央","右"];return o===1&&d===1?"中央":`${w[o]}${u[d]}`},k=j([]),m=j({totalSelections:0,avgSelectionTime:0,accuracyRate:0,zoneHitCounts:{}}),P=()=>{if(!h||!h.faceDetected.value)return null;const o=h.faceData;if(o.confidence<r.confidenceThreshold)return null;const{yaw:d,pitch:w}=o.headPose;let u=1;d<-15?u=2:d>15&&(u=0);let t=1;w<-10?t=0:w>10&&(t=2);const i=t*r.gridSize+u;return f.value.find(S=>S.id===i)},C=()=>{var d;const o=P();(o==null?void 0:o.id)!==((d=n.value)==null?void 0:d.id)&&($(),n.value=o,o&&I(o)),n.value&&c.value&&L()},I=o=>{o&&(c.value=!0,o.dwellStart=Date.now(),o.hovered=!0,f.value.forEach(d=>{d.id!==o.id&&(d.hovered=!1,d.dwellStart=null)}),console.log(`🎯 ゾーン選択開始: ${o.name}`))},L=()=>{if(!n.value||!n.value.dwellStart)return;const o=Date.now()-n.value.dwellStart,d=Math.min(o/r.dwellTime,1);s.value=d,d>=1&&E(n.value)},E=o=>{o&&(y.value=o,o.active=!0,k.push({zoneId:o.id,zoneName:o.name,timestamp:Date.now(),dwellTime:Date.now()-o.dwellStart}),q(o),console.log(`✅ ゾーン選択完了: ${o.name}`),T(o),setTimeout(()=>{Z()},500))},T=o=>{if(r.visualFeedback&&(o.active=!0,setTimeout(()=>{o.active=!1},300)),"speechSynthesis"in window){const d=new SpeechSynthesisUtterance(o.name);d.lang="ja-JP",d.rate=1.2,d.volume=.5,speechSynthesis.speak(d)}"vibrate"in navigator&&navigator.vibrate(100)},$=()=>{c.value=!1,s.value=0,f.value.forEach(o=>{o.hovered=!1,o.dwellStart=null})},Z=()=>{y.value=null,$(),f.value.forEach(o=>{o.active=!1})},q=o=>{m.totalSelections++,m.zoneHitCounts[o.id]||(m.zoneHitCounts[o.id]=0),m.zoneHitCounts[o.id]++;const d=Date.now()-o.dwellStart;m.avgSelectionTime=(m.avgSelectionTime*(m.totalSelections-1)+d)/m.totalSelections},B=o=>{Object.assign(r,o),console.log("⚙️ ゾーン設定更新:",r)},H=o=>f.value.find(d=>d.id===o),U=(o,d)=>f.value.find(w=>o>=w.x&&o<w.x+w.width&&d>=w.y&&d<w.y+w.height),Y=()=>({currentZone:n.value,isSelecting:c.value,dwellProgress:s.value,faceData:h==null?void 0:h.faceData,zones:f.value,stats:m,history:k.slice(-10)});return ne(()=>h==null?void 0:h.faceDetected.value,o=>{o||$()}),{currentZone:n,isSelecting:c,selectedZone:y,dwellProgress:s,zones:f,zoneConfig:r,selectionHistory:k,stats:m,processZoneSelection:C,resetSelection:Z,updateConfig:B,getZoneById:H,getZoneByCoordinates:U,getDebugInfo:Y,detectTargetZone:P,startDwellTimer:I,completeZoneSelection:E}}const pe=(h,n)=>{const c=h.__vccOpts||h;for(const[y,s]of n)c[y]=s;return c},ye={class:"eye-gaze-aac-app"},we={class:"app-header"},Se={class:"status-bar"},De={key:0,class:"face-info"},_e={class:"app-main"},be={class:"control-panel"},xe={class:"section"},ke=["disabled"],Pe=["value"],Ce=["disabled"],Fe={key:0,class:"section"},Te={key:1,class:"section"},Me={class:"pose-display"},ze={class:"pose-item"},$e={class:"pose-item"},Ae={class:"pose-visual"},Ie={class:"gaze-interface"},Ee={class:"zone-grid"},He={class:"zone-content"},Le={class:"zone-name"},Ze={class:"zone-number"},Ue={key:0,class:"dwell-circle"},Ne={width:"60",height:"60",class:"progress-ring"},Oe=["stroke-dashoffset"],Ve={class:"progress-text"},je={key:1,class:"selection-display"},qe={class:"selected-info"},Be={class:"zone-name-large"},Ye={class:"selection-time"},Ge={key:2,class:"usage-guide"},Re={class:"history-panel"},We={class:"section"},Xe={class:"history-list"},Je={class:"history-zone"},Ke={class:"history-time"},Qe={class:"section"},et={class:"stats-grid"},tt={class:"stat-item"},st={class:"stat-value"},ot={class:"stat-item"},nt={class:"stat-value"},at={class:"stat-item"},it={class:"stat-value"},lt={class:"camera-controls"},rt={key:0,class:"error-overlay"},ct={class:"error-content"},dt={__name:"App-EyeGaze",setup(h){const n=fe(),c=me(n),y=D(!0),s=D(!0),r=D(null),f=D([]),x=D(null),k=D(null),m=D(null),P=V(()=>{if(!n.faceDetected.value)return null;const u=n.faceData.headPose,t=window.innerWidth,i=window.innerHeight,S=t/2-u.yaw*8,M=i/2-u.pitch*6;return{x:Math.max(10,Math.min(t-10,S)),y:Math.max(10,Math.min(i-10,M))}}),C=V(()=>r.value?"status-error":n.isInitialized.value?n.isTracking.value?n.faceDetected.value?"status-tracking":"status-no-face":"status-ready":"status-initializing"),I=V(()=>r.value?"エラー":n.isInitialized.value?n.isTracking.value?n.faceDetected.value?"視線追跡中":"顔を検出中...":"準備完了":"初期化中..."),L=V(()=>{if(c.selectionHistory.length>0){const u=c.selectionHistory[c.selectionHistory.length-1];return new Date(u.timestamp).toLocaleTimeString()}return""}),E=V(()=>c.stats.totalSelections===0?0:Math.round(c.stats.totalSelections/(c.stats.totalSelections+1)*100));let T=null;const $=async()=>{try{await navigator.mediaDevices.getUserMedia({video:!0});const t=(await navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="videoinput");f.value=t.map(i=>({deviceId:i.deviceId,label:i.label||`カメラ ${f.value.length+1}`,groupId:i.groupId})),f.value.length>0&&!x.value&&(x.value=f.value[0]),console.log("📹 利用可能なカメラ:",f.value)}catch(u){r.value=`カメラアクセスエラー: ${u.message}`}},Z=async()=>{n.isTracking.value&&await H(),x.value&&console.log("📹 カメラ変更:",x.value.label)},q=async()=>{n.isTracking.value?await H():await B()},B=async()=>{try{if(!x.value){r.value="カメラを選択してください";return}await n.startTracking(k.value,m.value),U(),console.log("✅ 視線追跡開始")}catch(u){r.value=`追跡開始エラー: ${u.message}`}},H=async()=>{n.stopTracking(),Y(),c.resetSelection(),console.log("⏹️ 視線追跡停止")},U=()=>{const u=()=>{n.isTracking.value&&c.processZoneSelection(),n.isTracking.value&&(T=requestAnimationFrame(u))};T=requestAnimationFrame(u)},Y=()=>{T&&(cancelAnimationFrame(T),T=null)},o=()=>{r.value=null},d=async()=>{o(),await n.initializeFaceDetection()},w=u=>new Date(u).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",second:"2-digit"});return ne(()=>n.error.value,u=>{u&&(r.value=u)}),de(async()=>{console.log("🚀 視線入力AAC アプリケーション開始"),await ue(),await $();try{await n.initializeFaceDetection()}catch(u){r.value=`初期化エラー: ${u.message}`}}),oe(()=>{H()}),(u,t)=>(b(),_("div",ye,[e("header",we,[t[7]||(t[7]=e("h1",null,"👁️ 視線入力AAC - シンプル確実版",-1)),e("div",Se,[e("div",{class:J(["status-indicator",C.value])},p(I.value),3),v(n).faceDetected.value?(b(),_("div",De," 信頼度: "+p(Math.round(v(n).faceData.confidence*100))+"% | FPS: "+p(v(n).stats.fps),1)):A("",!0)])]),e("main",_e,[e("aside",be,[e("div",xe,[t[9]||(t[9]=e("h3",null,"📹 カメラ設定",-1)),X(e("select",{"onUpdate:modelValue":t[0]||(t[0]=i=>x.value=i),onChange:Z,disabled:v(n).isTracking.value},[t[8]||(t[8]=e("option",{value:""},"カメラを選択...",-1)),(b(!0),_(K,null,Q(f.value,i=>(b(),_("option",{key:i.deviceId,value:i},p(i.label),9,Pe))),128))],40,ke),[[ve,x.value]]),e("button",{onClick:q,disabled:!x.value,class:"primary-btn"},p(v(n).isTracking.value?"⏹️ 停止":"▶️ 開始"),9,Ce)]),v(n).isTracking.value?(b(),_("div",Fe,[t[11]||(t[11]=e("h3",null,"⚙️ 視線設定",-1)),e("label",null,[G(" ドウェル時間: "+p(v(c).zoneConfig.dwellTime)+"ms ",1),X(e("input",{type:"range",min:"800",max:"3000",step:"100","onUpdate:modelValue":t[1]||(t[1]=i=>v(c).zoneConfig.dwellTime=i)},null,512),[[se,v(c).zoneConfig.dwellTime]])]),e("label",null,[G(" 感度: "+p(Math.round(v(n).settings.smoothingFactor*100))+"% ",1),X(e("input",{type:"range",min:"0.3",max:"0.9",step:"0.1","onUpdate:modelValue":t[2]||(t[2]=i=>v(n).settings.smoothingFactor=i)},null,512),[[se,v(n).settings.smoothingFactor]])]),e("label",null,[X(e("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=i=>s.value=i)},null,512),[[he,s.value]]),t[10]||(t[10]=G(" 視線ポイント表示 "))])])):A("",!0),v(n).faceDetected.value?(b(),_("div",Te,[t[14]||(t[14]=e("h3",null,"🎯 頭部姿勢",-1)),e("div",Me,[e("div",ze,[t[12]||(t[12]=e("strong",null,"左右:",-1)),G(" "+p(Math.round(v(n).faceData.headPose.yaw))+"° ",1)]),e("div",$e,[t[13]||(t[13]=e("strong",null,"上下:",-1)),G(" "+p(Math.round(v(n).faceData.headPose.pitch))+"° ",1)]),e("div",Ae,[e("div",{class:"head-indicator",style:ee({transform:`translate(${v(n).faceData.headPose.yaw*2}px, ${v(n).faceData.headPose.pitch*2}px)`})},null,4)])])])):A("",!0)]),e("section",Ie,[s.value&&P.value?(b(),_("div",{key:0,class:"gaze-point",style:ee({left:`${P.value.x}px`,top:`${P.value.y}px`})},null,4)):A("",!0),e("div",Ee,[(b(!0),_(K,null,Q(v(c).zones.value,i=>{var S,M;return b(),_("div",{key:i.id,class:J(["zone-cell",{"zone-gazing":i.id===((S=v(c).currentZone.value)==null?void 0:S.id),"zone-dwelling":i.hovered,"zone-selected":i.id===((M=v(c).selectedZone.value)==null?void 0:M.id)}]),style:ee({left:`${i.x}%`,top:`${i.y}%`,width:`${i.width}%`,height:`${i.height}%`})},[e("div",He,[e("div",Le,p(i.name),1),e("div",Ze,p(i.id+1),1),i.hovered&&v(c).dwellProgress.value>0?(b(),_("div",Ue,[(b(),_("svg",Ne,[e("circle",{cx:"30",cy:"30",r:"25",stroke:"#f39c12","stroke-width":"4",fill:"none","stroke-dasharray":157,"stroke-dashoffset":157-157*v(c).dwellProgress.value/100,class:"progress-circle"},null,8,Oe)])),e("div",Ve,p(Math.round(v(c).dwellProgress.value))+"%",1)])):A("",!0)])],6)}),128))]),v(c).selectedZone.value!==null?(b(),_("div",je,[t[15]||(t[15]=e("h2",null,"✅ 選択されたゾーン",-1)),e("div",qe,[e("div",Be,p(v(c).selectedZone.value.name),1),e("div",Ye,p(L.value),1),e("button",{onClick:t[4]||(t[4]=i=>v(c).resetSelection()),class:"clear-btn"}," 🗑️ クリア ")])])):A("",!0),v(n).isTracking.value?A("",!0):(b(),_("div",Ge,[t[19]||(t[19]=e("h3",null,"💡 視線入力の使い方",-1)),e("ol",null,[t[16]||(t[16]=e("li",null,"📹 上のパネルでカメラを選択",-1)),t[17]||(t[17]=e("li",null,"▶️ 「開始」ボタンをクリック",-1)),t[18]||(t[18]=e("li",null,"👁️ 選択したいゾーンを見つめる",-1)),e("li",null,"⏰ "+p(Math.round(v(c).zoneConfig.dwellTime/1e3*10)/10)+"秒間見続けると選択",1)])]))]),e("aside",Re,[e("div",We,[t[20]||(t[20]=e("h3",null,"📊 選択履歴",-1)),e("div",Xe,[(b(!0),_(K,null,Q(v(c).selectionHistory.slice(-8),(i,S)=>(b(),_("div",{key:S,class:"history-item"},[e("div",Je,p(i.zoneName),1),e("div",Ke,p(w(i.timestamp)),1)]))),128))])]),e("div",Qe,[t[24]||(t[24]=e("h3",null,"📈 統計情報",-1)),e("div",et,[e("div",tt,[e("div",st,p(v(c).stats.totalSelections),1),t[21]||(t[21]=e("div",{class:"stat-label"},"総選択数",-1))]),e("div",ot,[e("div",nt,p(Math.round(v(c).stats.avgSelectionTime))+"ms",1),t[22]||(t[22]=e("div",{class:"stat-label"},"平均時間",-1))]),e("div",at,[e("div",it,p(E.value)+"%",1),t[23]||(t[23]=e("div",{class:"stat-label"},"精度",-1))])])])])]),e("div",{class:J(["camera-view",{"camera-minimized":!y.value}])},[e("video",{ref_key:"videoElement",ref:k,autoplay:"",muted:"",playsinline:"",class:"camera-video"},null,512),e("canvas",{ref_key:"canvasElement",ref:m,class:"camera-canvas",width:"640",height:"480"},null,512),e("div",lt,[e("button",{onClick:t[5]||(t[5]=i=>y.value=!y.value),class:"icon-btn"},p(y.value?"🙈":"👁️"),1),e("button",{onClick:t[6]||(t[6]=i=>v(n).settings.debugMode=!v(n).settings.debugMode),class:"icon-btn"}," 🔧 ")])],2),r.value?(b(),_("div",rt,[e("div",ct,[t[25]||(t[25]=e("h3",null,"⚠️ エラーが発生しました",-1)),e("p",null,p(r.value),1),e("div",{class:"error-actions"},[e("button",{onClick:o,class:"btn secondary"},"閉じる"),e("button",{onClick:d,class:"btn primary"},"再試行")])])])):A("",!0)]))}},ut=pe(dt,[["__scopeId","data-v-ac90537b"]]);window.addEventListener("error",h=>{console.error("🚨 Global Error:",h.error),console.error("File:",h.filename,"Line:",h.lineno)});window.addEventListener("unhandledrejection",h=>{console.error("🚨 Unhandled Promise Rejection:",h.reason)});console.log("🚀 Vue3 AAC アプリケーション開始");console.log("🌐 Environment:",{production:!0,base:"/eye-tracking-aac/",mode:"production"});try{const h=ge(ut);h.config.errorHandler=(n,c,y)=>{console.error("🚨 Vue Error:",n),console.error("Info:",y),console.error("Component:",c)},console.log("📱 Vue アプリケーションマウント中..."),h.mount("#app"),console.log("✅ Vue アプリケーションマウント完了")}catch(h){console.error("❌ Vue アプリケーション起動エラー:",h),document.getElementById("app").innerHTML=`
    <div style="padding: 20px; text-align: center; font-family: Arial, sans-serif;">
      <h1>🚨 エラーが発生しました</h1>
      <p>アプリケーションの読み込みに失敗しました。</p>
      <p>コンソール（F12）でエラー詳細を確認してください。</p>
      <button onclick="window.location.reload()" style="padding: 10px 20px; margin: 10px; background: #e74c3c; color: white; border: none; border-radius: 5px;">
        再読み込み
      </button>
    </div>
  `}
//# sourceMappingURL=index-HtrQt4ke.js.map
